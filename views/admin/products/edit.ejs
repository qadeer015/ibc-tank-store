<!-- views/admin/products/edit.ejs -->
<section class="mt-5">
    <form action="/admin/products/<%= product.id %>/update" method="POST" enctype="multipart/form-data" class="row g-3">
        <div class="row">
            <div class="col-lg-8">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label for="name" class="form-label fw-semibold">Product Name</label>
                        <input type="text" name="name" class="form-control" value="<%= product.name %>" required>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label for="price" class="form-label fw-semibold">Price</label>
                        <input type="number" name="price" class="form-control" value="<%= product.price %>" required>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label for="stock" class="form-label fw-semibold">Stock</label>
                        <input type="number" name="stock" class="form-control" value="<%= product.stock %>" required>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label for="product_condition" class="form-label fw-semibold">Select product condition</label>
                        <select name="product_condition" id="product_condition" class="form-select" required>
                            <option value=""></option>
                            <option value="New" <%=product.product_condition==='New' ? 'selected' : '' %>>New</option>
                            <option value="Used" <%=product.product_condition==='Used' ? 'selected' : '' %>>Used
                            </option>
                            <option value="Refurbished" <%=product.product_condition==='Refurbished' ? 'selected' : ''
                                %>>Refurbished</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label for="category_id" class="form-label fw-semibold">Select Category</label>
                        <select name="category_id" id="category_id" class="form-select" required>
                            <option value=""></option>
                            <% categories.forEach(category=> { %>
                                <option value="<%= category.id %>" <%=product.category_id===category.id ? 'selected'
                                    : '' %>>
                                    <%= category.name %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label for="description" class="form-label fw-semibold">Description</label>
                        <textarea class="form-control tinymce-editor" id="description" name="description" rows="10">
                        <%= product && product.description ? product.description : '' %>
                    </textarea>
                    </div>
                </div>
            </div>

            <!-- Enhanced Image Upload Section -->
            <div class="col-lg-4">
                <label class="form-label fw-semibold">Product Image</label>
                <div class="image-upload-container border rounded py-4 px-3 text-center">
                    <!-- Existing and new images preview -->
                    <div id="imagePreviewContainer" class="mb-3">
                        <div id="thumbnails" class="d-flex gap-2 flex-wrap justify-content-center"></div>
                    </div>

                    <!-- Upload Area -->
                    <div id="uploadArea" class="p-4 border-dashed rounded">
                        <input type="file" name="image" id="imageInput" class="d-none" accept="image/*" multiple>
                        <div class="upload-placeholder" onclick="document.getElementById('imageInput').click();">
                            <i class="bi bi-cloud-upload display-4 text-muted"></i>
                            <p class="mt-2 text-muted">Click to upload or drag and drop</p>
                            <small class="text-muted">SVG, PNG, JPG or GIF (max. 5MB)</small>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="uploadLoading" class="mt-3 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Processing image...</p>
                    </div>
                </div>
            </div>
        </div>

        <%= productImages %>

        <div class="col-12">
            <button type="submit" class="btn btn-success">Update Product</button>
            <a href="/admin/products" class="btn btn-outline-secondary mx-2">Cancel</a>
        </div>
    </form>
</section>

<script type="application/json" id="product-images-data">
    <%- JSON.stringify(productImages || []) %>
</script>

<script>
        const imageInput = document.getElementById('imageInput');
        const thumbnails = document.getElementById('thumbnails');
        const uploadArea = document.getElementById('uploadArea');
        const uploadLoading = document.getElementById('uploadLoading');
        
        // Existing images passed from server
        const existingImages = JSON.parse(document.getElementById('product-images-data').textContent);
        // Render existing images and attach hidden inputs
        function renderExisting() {
            existingImages.forEach((src, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'position-relative';
                wrap.style.maxWidth = '120px';

                const img = document.createElement('img');
                img.className = 'img-fluid rounded';
                img.style.maxHeight = '120px';
                img.src = src;

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm btn-outline-danger rounded-circle position-absolute top-0 end-0';
                btn.innerHTML = '<i class="bi bi-x"></i>';
                btn.addEventListener('click', () => removeExisting(idx));

                // Hidden input to keep this image
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'existingImages';
                hidden.value = src;

                wrap.appendChild(img);
                wrap.appendChild(btn);
                wrap.appendChild(hidden);
                thumbnails.appendChild(wrap);
            });
            updateUploadAreaVisibility();
        }

        function removeExisting(index) {
            // Remove both thumbnail and hidden input
            const wraps = Array.from(thumbnails.children);
            const target = wraps[index];
            if (target) thumbnails.removeChild(target);
            // Remove from existingImages array so it won't be sent
            existingImages.splice(index, 1);
            updateUploadAreaVisibility();
        }

        function renderNewPreviews(files) {
            // Render new file previews after existing ones
            // Clear any previous new-file previews (mark them)
            Array.from(thumbnails.querySelectorAll('[data-new]')).forEach(n => n.remove());

            Array.from(files).forEach((file, idx) => {
                const reader = new FileReader();
                const wrap = document.createElement('div');
                wrap.className = 'position-relative';
                wrap.style.maxWidth = '120px';
                wrap.setAttribute('data-new', 'true');

                const img = document.createElement('img');
                img.className = 'img-fluid rounded';
                img.style.maxHeight = '120px';

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm btn-outline-danger rounded-circle position-absolute top-0 end-0';
                btn.innerHTML = '<i class="bi bi-x"></i>';
                btn.addEventListener('click', () => removeNewFileAtIndex(idx));

                reader.onload = (e) => { img.src = e.target.result; };
                reader.readAsDataURL(file);

                wrap.appendChild(img);
                wrap.appendChild(btn);
                thumbnails.appendChild(wrap);
            });
            updateUploadAreaVisibility();
        }

        function removeNewFileAtIndex(index) {
            const dt = new DataTransfer();
            const files = Array.from(imageInput.files);
            files.forEach((f, i) => { if (i !== index) dt.items.add(f); });
            imageInput.files = dt.files;
            renderNewPreviews(imageInput.files);
        }

        function updateUploadAreaVisibility() {
            const total = thumbnails.children.length;
            if (total) {
                uploadArea.classList.add('d-none');
            } else {
                uploadArea.classList.remove('d-none');
            }
        }

        // Initialize existing images
        renderExisting();

        imageInput.addEventListener('change', function () {
            if (this.files && this.files.length) {
                uploadLoading.classList.remove('d-none');
                setTimeout(() => {
                    uploadLoading.classList.add('d-none');
                    renderNewPreviews(this.files);
                }, 300);
            } else {
                renderNewPreviews([]);
            }
        });
        // Drag and drop
        const uploadContainer = document.querySelector('.image-upload-container');
        uploadContainer.addEventListener('dragover', function (e) { e.preventDefault(); this.classList.add('border-primary'); this.querySelector('.upload-placeholder').classList.add('text-primary'); });
        uploadContainer.addEventListener('dragleave', function (e) { e.preventDefault(); this.classList.remove('border-primary'); this.querySelector('.upload-placeholder').classList.remove('text-primary'); });
        uploadContainer.addEventListener('drop', function (e) {
            e.preventDefault();
            this.classList.remove('border-primary');
            this.querySelector('.upload-placeholder').classList.remove('text-primary');
            if (e.dataTransfer.files.length) {
                imageInput.files = e.dataTransfer.files;
                const event = new Event('change');
                imageInput.dispatchEvent(event);
            }
        });
        // Form validation: ensure at least one image (existing or new)
        const form = document.querySelector('form');
        form.addEventListener('submit', function (e) {
            const existingCount = thumbnails.querySelectorAll('input[name="existingImages"]').length;
            const newCount = imageInput.files ? imageInput.files.length : 0;
            if (existingCount + newCount === 0) {
                e.preventDefault();
                alert('Please keep or upload at least one product image');
            }
        });
</script>

<style>
    .border-dashed {
        border: 2px dashed #dee2e6 !important;
    }

    .upload-placeholder {
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-placeholder:hover {
        transform: translateY(-2px);
    }

    .image-upload-container {
        transition: all 0.3s;
    }
</style>

<!-- Place the first <script> tag in your HTML's <head> -->
<script src="https://cdn.tiny.cloud/1/6gcbfrf9aa0izw5eu8u60vno25oxthr44mslcumic8b6l7y2/tinymce/8/tinymce.min.js"
    referrerpolicy="origin" crossorigin="anonymous"></script>

<script>

        let ai_request = (request, respondWith) => {
            respondWith.string((signal) =>
                fetch("/api/ai/gemini", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application / json",
                    },
                    body: JSON.stringify({
                        prompt: request.prompt
                    }),
                    signal
                })
                    .then(async (res) => {
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.error || "AI Error");
                        }

                        const data = await res.json();
                        return data.text;
                    })
            );
        };

    tinymce.init({
        selector: 'textarea',
        plugins: [
            // Core editing features
            'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
            // Your account includes a free trial of TinyMCE premium features
            // Try the most popular premium features until Jan 11, 2026:
            'checklist', 'mediaembed', 'casechange', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable', 'advcode', 'advtemplate', 'ai', 'uploadcare', 'mentions', 'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography', 'inlinecss', 'markdown', 'importword', 'exportword', 'exportpdf'
        ],
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography uploadcare | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat | aidialog aishortcuts',
        tinycomments_mode: 'embedded',
        tinycomments_author: 'Author name',
        mergetags_list: [
            { value: 'First.Name', title: 'First Name' },
            { value: 'Email', title: 'Email' },
        ],
        ai_request
    });
</script>