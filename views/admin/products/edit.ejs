<!-- views/admin/products/edit.ejs -->
<section class="mt-5">
<form action="/admin/products/<%= product.id %>/update" method="POST" enctype="multipart/form-data" class="row g-3">
    <div class="row">
        <div class="col-lg-8">
            <div class="row">
                <div class="col-md-4 mb-2">
                    <label for="name" class="form-label fw-semibold">Product Name</label>
                    <input type="text" name="name" class="form-control" 
                           value="<%= product.name %>" required>
                </div>
                <div class="col-md-4 mb-2">
                    <label for="price" class="form-label fw-semibold">Price</label>
                    <input type="number" name="price" class="form-control" 
                           value="<%= product.price %>" required>
                </div>
                <div class="col-md-4 mb-2">
                    <label for="stock" class="form-label fw-semibold">Stock</label>
                    <input type="number" name="stock" class="form-control" 
                           value="<%= product.stock %>" required>
                </div>
                <div class="col-md-4 mb-2">
                    <label for="product_condition" class="form-label fw-semibold">Select product condition</label>
                    <select name="product_condition" id="product_condition" class="form-select" required>
                        <option value=""></option>
                        <option value="New" <%= product.product_condition === 'New' ? 'selected' : '' %>>New</option>
                        <option value="Used" <%= product.product_condition === 'Used' ? 'selected' : '' %>>Used</option>
                        <option value="Refurbished" <%= product.product_condition === 'Refurbished' ? 'selected' : '' %>>Refurbished</option>
                    </select>
                </div>
                <div class="col-md-4 mb-2">
                    <label for="category_id" class="form-label fw-semibold">Select Category</label>
                    <select name="category_id" id="category_id" class="form-select" required>
                        <option value=""></option>
                        <% categories.forEach(category => { %>
                            <option value="<%= category.id %>" <%= product.category_id === category.id ? 'selected' : '' %>>
                                <%= category.name %>
                            </option>
                        <% }) %>
                    </select>
                </div>
                <div class="col-md-12 mb-3">
                    <label for="description" class="form-label fw-semibold">Description</label>
                    <textarea class="form-control tinymce-editor" id="description" name="description" rows="10">
                        <%= product && product.description ? product.description : '' %>
                    </textarea>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-semibold">Additional Information</label>
                        <div id="additional_info_container" class="mb-2">
                            <% if (product && product.additional_info && Object.keys(product.additional_info).length> 0)
                                { %>
                                <% Object.entries(product.additional_info).forEach(([key, value])=> { %>
                                    <div class="row additional-info-row mb-2">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" placeholder="Key"
                                                name="additional_info_key[]" value="<%= key %>">
                                        </div>
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" placeholder="Value"
                                                name="additional_info_value[]" value="<%= value %>">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button"
                                                class="btn btn-outline-danger btn-sm w-100 delete-row">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <% }) %>
                                        <% } else { %>
                                            <div class="row additional-info-row mb-2">
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" placeholder="Key"
                                                        name="additional_info_key[]">
                                                </div>
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" placeholder="Value"
                                                        name="additional_info_value[]">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button"
                                                        class="btn btn-outline-danger btn-sm w-100 delete-row"
                                                        style="display: none;">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <% } %>
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" id="add_additional_info_row">
                            <i class="bi bi-plus"></i> Add Row
                        </button>
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-semibold">Product Specifications</label>
                        <div id="specs_container" class="mb-2">
                            <% if (product && product.specs && Object.keys(product.specs).length> 0) { %>
                                <% Object.entries(product.specs).forEach(([key, value])=> { %>
                                    <div class="row specs-row mb-2">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" placeholder="Key" name="specs_key[]"
                                                value="<%= key %>">
                                        </div>
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" placeholder="Value"
                                                name="specs_value[]" value="<%= value %>">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button"
                                                class="btn btn-outline-danger btn-sm w-100 delete-row">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <% }) %>
                                        <% } else { %>
                                            <div class="row specs-row mb-2">
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" placeholder="Key"
                                                        name="specs_key[]">
                                                </div>
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" placeholder="Value"
                                                        name="specs_value[]">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button"
                                                        class="btn btn-outline-danger btn-sm w-100 delete-row"
                                                        style="display: none;">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <% } %>
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" id="add_specs_row">
                            <i class="bi bi-plus"></i> Add Row
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Image Upload Section -->
            <div class="col-lg-4">
                <label class="form-label fw-semibold">Product Image</label>
                <!-- Hidden container for existingImages inputs (inside form) -->
                <div id="existingImagesInputs" style="display: none;"></div>
                <div class="image-upload-container border rounded py-4 px-3 text-center">
                    <!-- Existing and new images preview -->
                    <div id="imagePreviewContainer" class="mb-3">
                        <div id="thumbnails" class="d-flex gap-2 flex-wrap justify-content-center"></div>
                    </div> <!-- Upload Area -->
                    <div id="uploadArea" class="p-4 border-dashed rounded">
                        <input type="file" name="image" id="imageInput" class="d-none" accept="image/*" multiple>
                        <div class="upload-placeholder" onclick="document.getElementById('imageInput').click();">
                            <i class="bi bi-cloud-upload display-4 text-muted"></i>
                            <p class="mt-2 text-muted">Click to upload or drag and drop</p>
                            <small class="text-muted">SVG, PNG, JPG or GIF (max. 5MB)</small>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="uploadLoading" class="mt-3 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Processing image...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Image Upload Section -->
        <div class="col-lg-4">
            <label class="form-label fw-semibold">Product Image</label>
            <div class="image-upload-container border rounded py-4 px-3 text-center">
                
                <!-- Existing Image Preview -->
                <div id="imagePreviewContainer" class="mb-3 position-relative <%= product.image ? '' : 'd-none' %>">
                    <% if(product.image) { %>
                        <img id="imagePreview" src="<%= product.image %>" alt="Product preview" class="img-fluid rounded" style="max-height: 200px;">
                    <% } else { %>
                        <img id="imagePreview" src="" alt="Product preview" class="img-fluid rounded" style="max-height: 200px;">
                    <% } %>
                    <input type="hidden" name="existingImage" value="<%= product.image %>">
                    <button type="button" id="removeImageBtn" class="btn btn-sm btn-outline-danger rounded-circle position-absolute top-0 end-0">
                        <i class="bi bi-x"></i>
                    </button>
                </div>

                <!-- Upload Area -->
                <div id="uploadArea" class="p-4 border-dashed rounded <%= product.image ? 'd-none' : '' %>">
                    <input type="file" name="image" id="imageInput" class="d-none" accept="image/*">
                    <div class="upload-placeholder" onclick="document.getElementById('imageInput').click();">
                        <i class="bi bi-cloud-upload display-4 text-muted"></i>
                        <p class="mt-2 text-muted">Click to upload or drag and drop</p>
                        <small class="text-muted">SVG, PNG, JPG or GIF (max. 5MB)</small>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="uploadLoading" class="mt-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Processing image...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <button type="submit" class="btn btn-success">Update Product</button>
        <a href="/admin/products" class="btn btn-outline-secondary mx-2">Cancel</a>
    </div>
</form>
</section>
<script>
    const imageInput = document.getElementById('imageInput');
    const thumbnails = document.getElementById('thumbnails');
    const uploadArea = document.getElementById('uploadArea');
    const uploadLoading = document.getElementById('uploadLoading');

    // Existing images passed from server
    const existingImages = JSON.parse(document.getElementById('product-images-data').textContent);

    // Render existing images and attach hidden inputs
    function renderExisting() {
        existingImages.forEach((src, idx) => {
            const wrap = document.createElement('div');
            wrap.className = 'position-relative';
            wrap.style.maxWidth = '120px';

            const img = document.createElement('img');
            img.className = 'img-fluid rounded';
            img.style.maxHeight = '120px';
            img.src = src;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-outline-danger rounded-circle position-absolute top-0 end-0';
            btn.innerHTML = '<i class="bi bi-x"></i>';
            btn.addEventListener('click', () => removeExisting(idx));

            // Hidden input to keep this image (append to form's hidden container, not thumbnail)
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'existingImages';
            hidden.value = src;
            document.getElementById('existingImagesInputs').appendChild(hidden);
            console.log('Created hidden input for:', src);

            wrap.appendChild(img);
            wrap.appendChild(btn);
            thumbnails.appendChild(wrap);
        });
        
        // Remove image functionality
        removeImageBtn.addEventListener('click', function() {
            imageInput.value = '';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('d-none');
            uploadArea.classList.remove('d-none');
        });
        
        // Drag and drop functionality
        const uploadContainer = document.querySelector('.image-upload-container');
        
        uploadContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('border-primary');
            this.querySelector('.upload-placeholder').classList.add('text-primary');
        });
        
        uploadContainer.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('border-primary');
            this.querySelector('.upload-placeholder').classList.remove('text-primary');
        });
        
        uploadContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('border-primary');
            this.querySelector('.upload-placeholder').classList.remove('text-primary');
            
            if(e.dataTransfer.files.length) {
                imageInput.files = e.dataTransfer.files;
                const event = new Event('change');
                imageInput.dispatchEvent(event);
            }
        });
    });

    // Dynamic Key-Value Rows for Additional Info
    document.getElementById('add_additional_info_row').addEventListener('click', function (e) {
        e.preventDefault();
        const container = document.getElementById('additional_info_container');
        const newRow = document.createElement('div');
        newRow.className = 'row additional-info-row mb-2';
        newRow.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="Key" name="additional_info_key[]">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="Value" name="additional_info_value[]">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm w-100 delete-row">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(newRow);
        updateDeleteButtons();
    });

    // Dynamic Key-Value Rows for Specs
    document.getElementById('add_specs_row').addEventListener('click', function (e) {
        e.preventDefault();
        const container = document.getElementById('specs_container');
        const newRow = document.createElement('div');
        newRow.className = 'row specs-row mb-2';
        newRow.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="Key" name="specs_key[]">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" placeholder="Value" name="specs_value[]">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm w-100 delete-row">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(newRow);
        updateDeleteButtons();
    });

    // Delete Row
    function updateDeleteButtons() {
        document.querySelectorAll('.delete-row').forEach((btn, index) => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                this.closest('.row').remove();
                updateDeleteButtons();
            });

            // Show delete button only if there's more than one row
            const container = btn.closest('[id$="_container"]');
            const rowCount = container.querySelectorAll('.row').length;
            if (rowCount > 1) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        });
    }

    // Initialize delete buttons on page load
    document.addEventListener('DOMContentLoaded', updateDeleteButtons);
</script>

<style>
    .border-dashed {
        border: 2px dashed #dee2e6 !important;
    }
    .upload-placeholder {
        cursor: pointer;
        transition: all 0.3s;
    }
    .upload-placeholder:hover {
        transform: translateY(-2px);
    }
    .image-upload-container {
        transition: all 0.3s;
    }
</style>

<!-- Place the first <script> tag in your HTML's <head> -->
<script src="https://cdn.tiny.cloud/1/f4pyogqxs5bgdb3qb41ycnlez42gj1s0k9m83yn2pkig50dx/tinymce/8/tinymce.min.js"
    referrerpolicy="origin" crossorigin="anonymous"></script>

<script>
    const GEMINI_API_KEY = "AIzaSyDijXFlEuJSGiS4Z-TUtoHMFVxfDMvZxWE";

    const ai_request = (request, respondWith) => {
        const geminiOptions = {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: request.prompt }
                        ]
                    }
                ],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 800,
                }
            })
        };

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        respondWith.string((signal) =>
            window.fetch(url, { signal, ...geminiOptions })
                .then(async (response) => {
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "Gemini API error");
                    }

                    const data = await response.json();

                    // Gemini response extraction
                    return data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                })
        );
    };

   tinymce.init({
        selector: 'textarea',
        plugins: [
            // Core editing features
            'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
            // Your account includes a free trial of TinyMCE premium features
            // Try the most popular premium features until Jan 11, 2026:
            'checklist', 'mediaembed', 'casechange', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable', 'advcode', 'advtemplate', 'ai', 'uploadcare', 'mentions', 'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography', 'inlinecss', 'markdown', 'importword', 'exportword', 'exportpdf'
        ],
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography uploadcare | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat | aidialog aishortcuts',
        tinycomments_mode: 'embedded',
        tinycomments_author: 'Author name',
        mergetags_list: [
            { value: 'First.Name', title: 'First Name' },
            { value: 'Email', title: 'Email' },
        ],
        ai_request,
        uploadcare_public_key: '8ae7bb47e4c81e246870',
    });
</script>