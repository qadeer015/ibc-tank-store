<!-- views/admin/contact/reply.ejs -->
<div class="row justify-content-center mt-4">
    <div class="col-lg-8 col-md-10">
        <!-- Header -->
        <div class="mb-4">
            <h4 class="fw-semibold mb-3">
                <i class="bi bi-reply-all me-2 text-primary"></i>
                Reply to <%= contact.name %>
            </h4>
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <p class="mt-3 mb-2">
                        <strong>To:</strong>
                        <a href="mailto:<%= contact.email %>" class="text-decoration-none">
                            <%= contact.email %>
                        </a>
                    </p>
                    <p class="mb-0">
                        <strong>Subject:</strong>
                        <span class="text-muted">Re: Your Inquiry</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Original Message -->
        <div class="mb-4">
            <div class="d-flex align-items-center justify-content-between">
                <h6 class="fw-semibold">Message</h6>
                <small class="text-muted ms-2">
                    <%= contact.created_at %>
                </small>
            </div>
            <div class="card border-0 bg-light">
                <div class="card-body pt-2">
                    <p class="mb-0 text-muted">
                        <%= contact.message %>
                    </p>
                </div>
            </div>
        </div>

        <!-- Reply Form -->
        <form action="/admin/contacts/<%= contact.id %>/send-reply" method="POST" class="needs-validation"
            id="replyForm">
            <div class="mb-3">
                <label for="reply_message" class="form-label fw-semibold">Write Your Reply</label>
                <textarea id="reply_message" name="reply_message" class="form-control tinymce-editor"
                    rows="8"></textarea>
            </div>

            <!-- Form Actions -->
            <div class="d-flex gap-2 justify-content-between">
                <a href="/admin/contacts/<%= contact.id %>" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send me-1"></i> Send Reply
                </button>
            </div>
        </form>
    </div>
</div>

<!-- TinyMCE Editor -->
<script src="https://cdn.tiny.cloud/1/6gcbfrf9aa0izw5eu8u60vno25oxthr44mslcumic8b6l7y2/tinymce/8/tinymce.min.js"
    referrerpolicy="origin" crossorigin="anonymous"></script>

<script>
    tinymce.init({
        selector: 'textarea',
        plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
        toolbar: 'undo redo | formatselect | bold italic underline strikethrough | link image media table | alignleft aligncenter alignright | bullist numlist | emoticons | code',
        height: 400,
        menubar: 'file edit view insert format tools table help',
        content_style: 'body { font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif; font-size:14px }',
        automatic_uploads: false,
        setup: function (editor) {
            editor.on('init', function () {
                console.log('TinyMCE editor initialized');
            });
        }
    });

    // Handle form submission
    document.getElementById('replyForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // Get the content from TinyMCE
        const replyContent = tinymce.get('reply_message').getContent();

        if (!replyContent.trim()) {
            alert('Please write a reply message');
            return;
        }

        const sendBtn = document.querySelector('#replyForm button[type="submit"]');
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Sending...';

        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                reply_message: replyContent
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Reply sent successfully!');
                    window.location.href = `/admin/contacts/<%= contact.id %>`;
                } else {
                    alert('Error sending reply: ' + (data.message || 'Unknown error'));
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="bi bi-send me-1"></i> Send Reply';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending reply: ' + error.message);
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="bi bi-send me-1"></i> Send Reply';
            });
    });
</script>